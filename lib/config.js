// Generated by IcedCoffeeScript 1.7.1-a
(function() {
  var Config, a_json_parse, base64u, chain, constants, fs, fullname, iced, key_query, keyring, log, make_esc, path, prng, request, tmpdir, url_join, __iced_k, __iced_k_noop, _ref, _ref1,
    __slice = [].slice;

  iced = require('iced-coffee-script/lib/coffee-script/iced').runtime;
  __iced_k = __iced_k_noop = function() {};

  constants = require('./constants').constants;

  fullname = require('./package').fullname;

  request = require('./request');

  log = require('./log');

  tmpdir = require('os').tmpdir;

  fs = require('fs');

  _ref = require('iced-error'), chain = _ref.chain, make_esc = _ref.make_esc;

  _ref1 = require('iced-utils').util, a_json_parse = _ref1.a_json_parse, base64u = _ref1.base64u;

  prng = require('crypto').prng;

  path = require('path');

  keyring = require('gpg-wrapper').keyring;

  key_query = require('./util').key_query;

  url_join = function() {
    var a, args, parts, rxx, trim;
    args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    rxx = /^(\/*)(.*?)(\/*)$/;
    trim = function(s) {
      var m;
      if ((m = s.match(rxx)) != null) {
        return m[2];
      } else {
        return s;
      }
    };
    parts = (function() {
      var _i, _len, _results;
      _results = [];
      for (_i = 0, _len = args.length; _i < _len; _i++) {
        a = args[_i];
        _results.push(trim(a));
      }
      return _results;
    })();
    return parts.join('/');
  };

  exports.Config = Config = (function() {
    function Config(argv, master_ring) {
      this.argv = argv;
      this._tmpdir = null;
      this._master_ring = master_ring || keyring.master_ring();
    }

    Config.prototype.master_ring = function() {
      return this._master_ring;
    };

    Config.prototype.set_master_ring = function(r) {
      return this._master_ring = r || keyring.master_ring();
    };

    Config.prototype.url_prefix = function() {
      var prot, u;
      if ((u = this.argv.get("u", "url-prefix"))) {
        return u;
      } else {
        prot = this.argv.get("S", "no-https") ? 'http' : 'https';
        return constants.url_prefix[prot];
      }
    };

    Config.prototype.make_url = function(u) {
      return url_join(this.url_prefix(), u);
    };

    Config.prototype.get_tmpdir = function() {
      return this._tmpdir;
    };

    Config.prototype.make_tmpdir = function(cb) {
      var err, r, ___iced_passed_deferral, __iced_deferrals, __iced_k;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      err = null;
      (function(_this) {
        return (function(__iced_k) {
          if (_this._tmpdir == null) {
            r = base64u.encode(prng(16));
            _this._tmpdir = path.join(tmpdir(), "keybase_install_" + r);
            (function(__iced_k) {
              __iced_deferrals = new iced.Deferrals(__iced_k, {
                parent: ___iced_passed_deferral,
                filename: "/Users/max/src/keybase-node-installer/src/config.iced",
                funcname: "Config.make_tmpdir"
              });
              fs.mkdir(_this._tmpdir, 0x1c0, __iced_deferrals.defer({
                assign_fn: (function() {
                  return function() {
                    return err = arguments[0];
                  };
                })(),
                lineno: 59
              }));
              __iced_deferrals._fulfill();
            })(function() {
              return __iced_k(log.info("Made temporary directory: " + _this._tmpdir));
            });
          } else {
            return __iced_k();
          }
        });
      })(this)((function(_this) {
        return function() {
          return cb(err);
        };
      })(this));
    };

    Config.prototype.cleanup = function(cb) {
      var esc, f, files, p, ___iced_passed_deferral, __iced_deferrals, __iced_k;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      esc = make_esc(cb, "Installer::cleanup");
      (function(_this) {
        return (function(__iced_k) {
          if (_this._tmpdir == null) {
            return __iced_k();
          } else {
            (function(__iced_k) {
              if (_this.argv.get("C", "skip-cleanup")) {
                return __iced_k(log.info("Preserving tmpdir " + _this._tmpdir + " as per command-line switch"));
              } else {
                log.info("cleaning up tmpdir " + _this._tmpdir);
                (function(__iced_k) {
                  __iced_deferrals = new iced.Deferrals(__iced_k, {
                    parent: ___iced_passed_deferral,
                    filename: "/Users/max/src/keybase-node-installer/src/config.iced",
                    funcname: "Config.cleanup"
                  });
                  fs.readdir(_this._tmpdir, esc(__iced_deferrals.defer({
                    assign_fn: (function() {
                      return function() {
                        return files = arguments[0];
                      };
                    })(),
                    lineno: 72
                  })));
                  __iced_deferrals._fulfill();
                })(function() {
                  (function(__iced_k) {
                    var _i, _len, _ref2, _results, _while;
                    _ref2 = files;
                    _len = _ref2.length;
                    _i = 0;
                    _results = [];
                    _while = function(__iced_k) {
                      var _break, _continue, _next;
                      _break = function() {
                        return __iced_k(_results);
                      };
                      _continue = function() {
                        return iced.trampoline(function() {
                          ++_i;
                          return _while(__iced_k);
                        });
                      };
                      _next = function(__iced_next_arg) {
                        _results.push(__iced_next_arg);
                        return _continue();
                      };
                      if (!(_i < _len)) {
                        return _break();
                      } else {
                        f = _ref2[_i];
                        p = path.join(_this._tmpdir, f);
                        (function(__iced_k) {
                          __iced_deferrals = new iced.Deferrals(__iced_k, {
                            parent: ___iced_passed_deferral,
                            filename: "/Users/max/src/keybase-node-installer/src/config.iced",
                            funcname: "Config.cleanup"
                          });
                          fs.unlink(p, esc(__iced_deferrals.defer({
                            lineno: 75
                          })));
                          __iced_deferrals._fulfill();
                        })(_next);
                      }
                    };
                    _while(__iced_k);
                  })(function() {
                    (function(__iced_k) {
                      __iced_deferrals = new iced.Deferrals(__iced_k, {
                        parent: ___iced_passed_deferral,
                        filename: "/Users/max/src/keybase-node-installer/src/config.iced",
                        funcname: "Config.cleanup"
                      });
                      fs.rmdir(_this._tmpdir, esc(__iced_deferrals.defer({
                        lineno: 76
                      })));
                      __iced_deferrals._fulfill();
                    })(__iced_k);
                  });
                });
              }
            })(__iced_k);
          }
        });
      })(this)((function(_this) {
        return function() {
          return cb(null);
        };
      })(this));
    };

    Config.prototype.request = function(u, cb) {
      var body, err, opts, res, url, ___iced_passed_deferral, __iced_deferrals, __iced_k;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      url = u.match("^https?://") ? u : this.make_url(u);
      opts = {
        url: url,
        headers: {
          "X-Keybase-Installer": fullname()
        },
        maxRedirects: 10,
        progress: 50000
      };
      log.info("Fetching URL " + url);
      (function(_this) {
        return (function(__iced_k) {
          __iced_deferrals = new iced.Deferrals(__iced_k, {
            parent: ___iced_passed_deferral,
            filename: "/Users/max/src/keybase-node-installer/src/config.iced",
            funcname: "Config.request"
          });
          request(opts, __iced_deferrals.defer({
            assign_fn: (function() {
              return function() {
                err = arguments[0];
                res = arguments[1];
                return body = arguments[2];
              };
            })(),
            lineno: 89
          }));
          __iced_deferrals._fulfill();
        });
      })(this)((function(_this) {
        return function() {
          log.debug(" * fetched -> " + (typeof res !== "undefined" && res !== null ? res.statusCode : void 0));
          return cb(err, res, body);
        };
      })(this));
    };

    Config.prototype.set_key_version = function(v) {
      this._key_version = v;
      return log.info("Using key version v" + v);
    };

    Config.prototype.key_version = function() {
      return this._key_version;
    };

    Config.prototype.set_index = function(i) {
      return this._index = i;
    };

    Config.prototype.index = function() {
      return this._index;
    };

    Config.prototype.index_lookup_hash = function(v) {
      var _ref2, _ref3;
      return (_ref2 = this._index["package"]) != null ? (_ref3 = _ref2.all) != null ? _ref3[v] : void 0 : void 0;
    };

    Config.prototype.oneshot_verify = function(_arg, cb) {
      var err, file, json, query, sig, which, ___iced_passed_deferral, __iced_deferrals, __iced_k;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      which = _arg.which, sig = _arg.sig, file = _arg.file;
      query = key_query(this._key_version, which);
      (function(_this) {
        return (function(__iced_k) {
          __iced_deferrals = new iced.Deferrals(__iced_k, {
            parent: ___iced_passed_deferral,
            filename: "/Users/max/src/keybase-node-installer/src/config.iced",
            funcname: "Config.oneshot_verify"
          });
          _this.master_ring().oneshot_verify({
            query: query,
            file: file,
            sig: sig,
            single: true
          }, __iced_deferrals.defer({
            assign_fn: (function() {
              return function() {
                err = arguments[0];
                return json = arguments[1];
              };
            })(),
            lineno: 116
          }));
          __iced_deferrals._fulfill();
        });
      })(this)((function(_this) {
        return function() {
          return cb(err, json);
        };
      })(this));
    };

    return Config;

  })();

}).call(this);
